#!/bin/bash

set -e

upgrade_mysql() {
  echo "Running mysql_upgrade..."

  local exitstatus=0
  # Hide failures from "already upgraded", otherwise let it bubble up
  if ! output=$($(brew --prefix mysql@5.7)/bin/mysql_upgrade -u root); then
    exitstatus="$?"
    if echo "$output" | grep --quiet "already upgraded"; then
      exitstatus=0
    else
      # If there's some other reason for this, we want to make sure it's heard
      echo "$output"
    fi
  fi

  return $exitstatus
}

update_my_cnf() {
  CNF_PATH="$(brew --prefix)/etc/my.cnf"

  touch $CNF_PATH

  echo "Backing up old my.cnf file..."
  cp -vf $CNF_PATH "$CNF_PATH.github"

  cat > $CNF_PATH <<-EOM
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/5.7/en/server-configuration-defaults.html

[mysqld]

innodb_strict_mode=OFF
optimizer_switch='index_merge_intersection=OFF'
query_cache_size=0
sql_mode=NO_ENGINE_SUBSTITUTION
EOM
}


if [[ -d $(brew --prefix mysql@5.6) || -d $(brew --prefix mysql@5.7) ]]; then
  if [[ -d $(brew --prefix mysql@5.6) ]]; then
    brew services stop mysql@5.6 || true
    brew install mysql@5.7
  fi

  brew services stop mysql@5.7 || true

  update_my_cnf

  brew services start mysql@5.7

  while ! $(brew --prefix mysql@5.7)/bin/mysqladmin ping --silent; do
    echo "Waiting for MySQL to be available..."
    sleep 2
  done

  upgrade_mysql

  # We need to give MySQL to shut down properly, let's not do a restart
  brew services stop mysql@5.7
  brew services start mysql@5.7

  while ! $(brew --prefix mysql@5.7)/bin/mysqladmin ping --silent; do
    echo "Waiting for MySQL to be available..."
    sleep 2
  done

fi

exit 0
